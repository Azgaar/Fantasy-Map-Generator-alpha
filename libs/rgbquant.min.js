// Â© 2015, Leon Sorokin, MIT
(function(){function t(t){var s;t=t||{},this.method=t.method||2,this.colors=t.colors||256,this.initColors=t.initColors||4096,this.initDist=t.initDist||.01,this.distIncr=t.distIncr||.005,this.hueGroups=t.hueGroups||10,this.satGroups=t.satGroups||10,this.lumGroups=t.lumGroups||10,this.minHueCols=t.minHueCols||0,this.hueStats=this.minHueCols?new i(this.hueGroups,this.minHueCols):null,this.boxSize=t.boxSize||[64,64],this.boxPxls=t.boxPxls||2,this.palLocked=!1,this.dithKern=t.dithKern||null,this.dithSerp=t.dithSerp||!1,this.dithDelta=t.dithDelta||0,this.histogram={},this.idxrgb=t.palette?t.palette.slice(0):[],this.idxi32=[],this.i32idx={},this.i32rgb={},this.useCache=!1!==t.useCache,this.cacheFreq=t.cacheFreq||10,this.reIndex=t.reIndex||0==this.idxrgb.length,this.colorDist="manhattan"==t.colorDist?n:r,0<this.idxrgb.length&&(s=this).idxrgb.forEach(function(t,i){var r=(255<<24|t[2]<<16|t[1]<<8|t[0])>>>0;s.idxi32[i]=r,s.i32idx[r]=i,s.i32rgb[r]=t})}function i(t,i){this.numGroups=t,this.minCols=i,this.stats={};for(var r=-1;r<t;r++)this.stats[r]={num:0,cols:[]};this.groupsFull=0}t.prototype.sample=function(t,i){if(this.palLocked)throw"Cannot sample additional images, palette already assembled.";var r=F(t,i);switch(this.method){case 1:this.colorStats1D(r.buf32);break;case 2:this.colorStats2D(r.buf32,r.width)}},t.prototype.reduce=function(t,i,r,s){if(this.palLocked||this.buildPal(),r=r||this.dithKern,s=void 0!==s?s:this.dithSerp,i=i||1,r)var e=this.dither(t,r,s);else for(var h=F(t).buf32,n=h.length,e=new Uint32Array(n),a=0;a<n;a++){var o=h[a];e[a]=this.nearestColor(o)}if(1==i)return new Uint8Array(e.buffer);if(2==i){for(var u=[],n=e.length,a=0;a<n;a++){o=e[a];u[a]=this.i32idx[o]}return u}},t.prototype.dither=function(t,i,r){var s={FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[.25,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],Jarvis:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Burkes:[[.25,1,0],[.125,2,0],[2/32,-2,1],[.125,-1,1],[.25,0,1],[.125,1,1],[2/32,2,1]],Sierra:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[.125,-1,1],[5/32,0,1],[.125,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]],TwoSierra:[[.25,1,0],[3/16,2,0],[1/16,-2,1],[.125,-1,1],[3/16,0,1],[.125,1,1],[1/16,2,1]],SierraLite:[[.5,1,0],[.25,-1,1],[.25,0,1]]};if(!i||!s[i])throw"Unknown dithering kernel: "+i;for(var e=s[i],t=F(t),h=t.buf32,n=t.width,a=t.height,o=(h.length,r?-1:1),u=0;u<a;u++){r&&(o*=-1);for(var l=u*n,c=1==o?0:n-1,d=1==o?n:0;c!==d;c+=o){var f=l+c,x=h[f],p=255&x,g=(65280&x)>>8,b=(16711680&x)>>16,m=this.nearestColor(x),v=255&m,x=(65280&m)>>8,m=(16711680&m)>>16;if(h[f]=255<<24|m<<16|x<<8|v,this.dithDelta)if(this.colorDist([p,g,b],[v,x,m])<this.dithDelta)continue;for(var y=p-v,w=g-x,S=b-m,C=1==o?0:e.length-1,k=1==o?e.length:0;C!==k;C+=o){var D,M,A=e[C][1]*o,I=e[C][2],P=I*n;0<=A+c&&A+c<n&&0<=I+u&&I+u<a&&(M=e[C][0],I=255&h[D=f+(P+A)],P=(65280&h[D])>>8,A=(16711680&h[D])>>16,I=Math.max(0,Math.min(255,I+y*M)),P=Math.max(0,Math.min(255,P+w*M)),M=Math.max(0,Math.min(255,A+S*M)),h[D]=255<<24|M<<16|P<<8|I)}}}return h},t.prototype.buildPal=function(t){if(!(this.palLocked||0<this.idxrgb.length&&this.idxrgb.length<=this.colors)){var i=this.histogram,r=function(r,s){var t,i=[];for(t in r)i.push(t);return b.call(i,function(t,i){return s?r[i]-r[t]:r[t]-r[i]})}(i,!0);if(0==r.length)throw"Nothing has been sampled, palette cannot be built.";switch(this.method){case 1:for(var s=this.initColors,e=i[r[s-1]],h=r.slice(0,s),n=s,a=r.length;n<a&&i[r[n]]==e;)h.push(r[n++]);this.hueStats&&this.hueStats.inject(h);break;case 2:h=r}h=h.map(function(t){return+t}),this.reducePal(h),!t&&this.reIndex&&this.sortPal(),this.useCache&&this.cacheHistogram(h),this.palLocked=!0}},t.prototype.palette=function(t,i){return this.buildPal(i),t?this.idxrgb:new Uint8Array(new Uint32Array(this.idxi32).buffer)},t.prototype.prunePal=function(t){for(var i,r=0;r<this.idxrgb.length;r++)t[r]||(i=this.idxi32[r],this.idxrgb[r]=null,this.idxi32[r]=null,delete this.i32idx[i]);if(this.reIndex){for(var s=[],e=[],h={},r=0,n=0;r<this.idxrgb.length;r++)this.idxrgb[r]&&(i=this.idxi32[r],s[n]=this.idxrgb[r],e[h[i]=n]=i,n++);this.idxrgb=s,this.idxi32=e,this.i32idx=h}},t.prototype.reducePal=function(t){if(this.idxrgb.length>this.colors){for(var i,r=t.length,s={},e=0,h=!1,n=0;n<r;n++)e!=this.colors||h||(this.prunePal(s),h=!0),i=this.nearestIndex(t[n]),e<this.colors&&!s[i]&&(s[i]=!0,e++);h||(this.prunePal(s),h=!0)}else{var a=t.map(function(t){return[255&t,(65280&t)>>8,(16711680&t)>>16]}),o=r=a.length,u=this.initDist;if(o>this.colors){for(;o>this.colors;){for(var l=[],n=0;n<r;n++){var c=a[n];t[n];if(c)for(var d=n+1;d<r;d++){var f,x=a[d],p=t[d];x&&((f=this.colorDist(c,x))<u&&(l.push([d,x,p,f]),delete a[d],o--))}}u+=o>3*this.colors?this.initDist:this.distIncr}if(o<this.colors){b.call(l,function(t,i){return i[3]-t[3]});for(var g=0;o<this.colors;)a[l[g][0]]=l[g][1],o++,g++}}for(r=a.length,n=0;n<r;n++)a[n]&&(this.idxrgb.push(a[n]),this.idxi32.push(t[n]),this.i32idx[t[n]]=this.idxi32.length-1,this.i32rgb[t[n]]=a[n])}},t.prototype.colorStats1D=function(t){for(var i,r=this.histogram,s=t.length,e=0;e<s;e++)(4278190080&(i=t[e]))>>24!=0&&(this.hueStats&&this.hueStats.check(i),i in r?r[i]++:r[i]=1)},t.prototype.colorStats2D=function(e,h){var t=this.boxSize[0],i=this.boxSize[1],n=t*i,i=function(t,i,r,s){for(var e=t%r,h=i%s,n=t-e,a=i-h,o=[],u=0;u<i;u+=s)for(var l=0;l<t;l+=r)o.push({x:l,y:u,w:l==n?e:r,h:u==a?h:s});return o}(h,e.length/h,t,i),a=this.histogram,o=this;i.forEach(function(t){var i,r=Math.max(Math.round(t.w*t.h/n)*o.boxPxls,2),s={};!function(t,i,r){for(var s=t,t=s.y*i+s.x,e=(s.y+s.h-1)*i+(s.x+s.w-1),h=0,n=i-s.w+1,a=t;r.call(this,a),a+=++h%s.w==0?n:1,a<=e;);}(t,h,function(t){(4278190080&(i=e[t]))>>24!=0&&(o.hueStats&&o.hueStats.check(i),i in a?a[i]++:i in s?++s[i]>=r&&(a[i]=s[i]):s[i]=1)})}),this.hueStats&&this.hueStats.inject(a)},t.prototype.sortPal=function(){var e=this;this.idxi32.sort(function(t,i){var r=e.i32idx[t],s=e.i32idx[i],t=e.idxrgb[r],i=e.idxrgb[s],r=a(t[0],t[1],t[2]),s=a(i[0],i[1],i[2]),t=t[0]==t[1]&&t[1]==t[2]?-1:c(r.h,e.hueGroups),t=(i[0]==i[1]&&i[1]==i[2]?-1:c(s.h,e.hueGroups))-t;if(t)return-t;t=+s.l.toFixed(2)-+r.l.toFixed(2);if(t)return-t;r=+s.s.toFixed(2)-+r.s.toFixed(2);return r?-r:void 0}),this.idxi32.forEach(function(t,i){e.idxrgb[i]=e.i32rgb[t],e.i32idx[t]=i})},t.prototype.nearestColor=function(t){t=this.nearestIndex(t);return null===t?0:this.idxi32[t]},t.prototype.nearestIndex=function(t){if((4278190080&t)>>24==0)return null;if(this.useCache&&""+t in this.i32idx)return this.i32idx[t];for(var i,r,s=1e3,e=[255&t,(65280&t)>>8,(16711680&t)>>16],h=this.idxrgb.length,n=0;n<h;n++)this.idxrgb[n]&&((r=this.colorDist(e,this.idxrgb[n]))<s&&(s=r,i=n));return i},t.prototype.cacheHistogram=function(t){for(var i=0,r=t[i];i<t.length&&this.histogram[r]>=this.cacheFreq;r=t[i++])this.i32idx[r]=this.nearestIndex(r)},i.prototype.check=function(t){this.groupsFull==this.numGroups+1&&(this.check=function(){});var i=255&t,r=(65280&t)>>8,s=(16711680&t)>>16,i=i==r&&r==s?-1:c(a(i,r,s).h,this.numGroups),r=this.stats[i],s=this.minCols;r.num++,r.num>s||(r.num==s&&this.groupsFull++,r.num<=s&&this.stats[i].cols.push(t))},i.prototype.inject=function(i){for(var t=-1;t<this.numGroups;t++)if(this.stats[t].num<=this.minCols)switch(d(i)){case"Array":this.stats[t].cols.forEach(function(t){-1==i.indexOf(t)&&i.push(t)});break;case"Object":this.stats[t].cols.forEach(function(t){i[t]?i[t]++:i[t]=1})}};var o=.2126,u=.7152,l=.0722;var e=Math.sqrt(255*o*255+255*u*255+255*l*255);function r(t,i){var r=i[0]-t[0],s=i[1]-t[1],t=i[2]-t[2];return Math.sqrt(o*r*r+u*s*s+l*t*t)/e}var h=255*o+255*u+255*l;function n(t,i){var r=Math.abs(i[0]-t[0]),s=Math.abs(i[1]-t[1]),t=Math.abs(i[2]-t[2]);return(o*r+u*s+l*t)/h}function a(t,i,r){var s,e,h,n,a;if(t/=255,i/=255,r/=255,(n=Math.max(t,i,r))==(h=Math.min(t,i,r)))s=a=0;else{switch(e=n-h,a=.5<(n+h)/2?e/(2-n-h):e/(n+h),n){case t:s=(i-r)/e+(i<r?6:0);break;case i:s=(r-t)/e+2;break;case r:s=(t-i)/e+4}s/=6}return{h:s,s:a,l:(h=t,n=i,a=r,Math.sqrt(o*h*h+u*n*n+l*a*a))}}function c(t,i){var r=1/i,s=r/2;if(1-s<=t||t<=s)return 0;for(var e=1;e<i;e++){var h=e*r;if(h-s<=t&&t<=h+s)return e}}function d(t){return Object.prototype.toString.call(t).slice(8,-1)}var s,b="xyzvwtursopqmnklhijfgdeabc"==(s="abcdefghijklmnopqrstuvwxyz").split("").sort(function(t,i){return~~(s.indexOf(i)/2.3)-~~(s.indexOf(t)/2.3)}).join("")?Array.prototype.sort:function(r){var t=d(this[0]);{if("Number"==t||"String"==t){for(var i,s={},e=this.length,h=0;h<e;h++)i=this[h],s[i]||0===s[i]||(s[i]=h);return this.sort(function(t,i){return r(t,i)||s[t]-s[i]})}s=this.map(function(t){return t});return this.sort(function(t,i){return r(t,i)||s.indexOf(t)-s.indexOf(i)})}};function F(t,i){var r,s,e,h,n,a;switch(d(t)){case"HTMLImageElement":(r=document.createElement("canvas")).width=t.naturalWidth,r.height=t.naturalHeight,(s=r.getContext("2d")).drawImage(t,0,0);case"Canvas":case"HTMLCanvasElement":r=r||t,s=s||r.getContext("2d");case"CanvasRenderingContext2D":s=s||t,r=r||s.canvas,e=s.getImageData(0,0,r.width,r.height);case"ImageData":i=(e=e||t).width,h="CanvasPixelArray"==d(e.data)?new Uint8Array(e.data):e.data;case"Array":case"CanvasPixelArray":h=h||new Uint8Array(t);case"Uint8Array":case"Uint8ClampedArray":h=h||t,n=new Uint32Array(h.buffer);case"Uint32Array":n=n||t,h=h||new Uint8Array(n.buffer),i=i||n.length,a=n.length/i}return{can:r,ctx:s,imgd:e,buf8:h,buf32:n,width:i,height:a}}this.RgbQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);